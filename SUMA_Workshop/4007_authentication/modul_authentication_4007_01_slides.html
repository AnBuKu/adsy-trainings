<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>SUSE Manager 3 Authentication</title>

    <link rel="stylesheet" href="../common/reveal.js/css/reveal.css">
    <link rel="stylesheet" href="../common/reveal.js/css/theme/white.css">
    <link rel="stylesheet" href="../common/css/reveal-adsy.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="../common/css/monokai.css">
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
<section id="suse-manager-3---authentication" class="slide level1">
<h1>SUSE Manager 3 - Authentication</h1>
<figure>
<img src="static/suma.png" />
</figure>
</section>
<section class="slide level1">

<section id="agenda" class="level2">
<h2>Agenda</h2>
<ul>
<li><p>SSSD</p></li>
<li><p>PAM</p></li>
<li><p>User Import</p></li>
</ul>
</section>
</section>
<section class="slide level1">

<section id="sssd" class="level2">
<h2>SSSD</h2>
<p>Provider</p>
<ul>
<li><p>LDAP</p></li>
<li><p>Active Directory</p></li>
<li><p>Identity Management</p></li>
<li><p>Kerberos (auth only)</p></li>
</ul>
</section>
<section id="sssd---ad-provider" class="level2">
<h2>SSSD - AD Provider</h2>
<p>Example configuration <code>/etc/sssd/sssd.conf</code></p>
<pre class="ini"><code>[nss]
filter_users = root
filter_groups = root

[pam]

[sssd]
config_file_version = 2
services = nss, pam
domains = sub.mydomain.com

[domain/sub.mydomain.com]
ad_server =  dc1.sub.mydomain.com, dc2.sub.mydomain.com
id_provider = ad
default_shell = /bin/bash
ad_access_filter = (memberOf=cn=admins,ou=groups,dc=mydomain,dc=com)
</code></pre>
</section>
<section id="sssd---nsswitch" class="level2">
<h2>SSSD - nsswitch</h2>
<p>Example <code>/etc/nsswitch.conf</code></p>
<pre class="text"><code>passwd: file sss
group:  file sss
shadow: file sss</code></pre>
</section>
<section id="sssd---nscd" class="level2">
<h2>SSSD - nscd</h2>
<p>Must to be stoped and disbaled as sssd now caches:</p>
<pre class="text"><code># systemctl stop nscd.service

# systemctl disable nscd.service
</code></pre>
</section>
</section>
<section class="slide level1">

<section id="pam" class="level2">
<h2>PAM</h2>
<p><code>/etc/pam.d/common-auth</code></p>
<pre class="text"><code>auth    required        pam_env.so
auth    sufficient      pam_unix.so     try_first_pass
auth    sufficient      pam_krb5.so     use_first_pass
auth    required        pam_sss.so      use_first_pass
</code></pre>
<p><code>/etc/pam.d/susemanager</code></p>
<pre class="text"><code>auth     include        common-auth
account  include        common-account
password include        common-password
</code></pre>
<p><code>/etc/rhn/rhn.conf</code></p>
<pre class="text"><code>pam_auth_service = susemanager
</code></pre>
</section>
</section>
<section class="slide level1">

<section id="user-import" class="level2">
<h2>User import</h2>
<pre class="bash"><code>## Configuration ##
#AD Group
ADGROUP=APP_RH_SUSEManager
# SUMA Local Admin
SPACEUSR=Admin
# SUMA Local Password
SPACEPW=...
# Domain Part of EMAIL address
DOMAIN_EMAIL=sub.mydomain.com
# Roles that need to be assigned to the user
ROLES=&quot;satellite_admin activation_key_admin system_group_admin org_admin config_admin channel_admin&quot;

## Automatic Lists ##
SCMD=&quot;/usr/bin/spacecmd -y -q -u $SPACEUSR -p $SPACEPW&quot;
GRPUSRS=$(getent group &quot;${ADGROUP}&quot; | cut -f4 -d: | sed &#39;s/,/ /g&#39; | sed &quot;s/\&#39;//g&quot;)
SUMAUSRS=$($SCMD user_list | grep -v -x $SPACEUSR)

## Magic ##
for each in ${GRPUSRS}
        do
        PAM_USER=&quot;${each}&quot;
        USREXIST=$(echo &quot;$SUMAUSRS&quot; | grep -x &quot;$PAM_USER&quot;)
        if [ -z &quot;${USREXIST}&quot; ]; then
           ${SCMD} &quot;user_create -u ${PAM_USER} -f ${PAM_USER} -l ${PAM_USER} -e ${PAM_USER}@${DOMAIN_EMAIL} --pam &quot;
           for each in ${ROLES}
             do
             ${SCMD} user_addrole ${PAM_USER} &quot;${each}&quot;
           done
           logger $0 : added ${each} as SUMA Admin
        fi
done

for each in ${SUMAUSRS}
        do
                if [ &quot;${each}&quot; == &quot;${SPACEUSR}&quot; ]; then
                        break
                fi
                echo ${GRPUSRS} | grep &quot;${each}&quot; &gt; /dev/null
                if [ &quot;$?&quot; -gt 0 ]; then
                        ${SCMD} user_delete &quot;${each}&quot;
                        logger $0 : removed ${each} from SUMA Admins
                fi
done
</code></pre>
</section>
<section id="user-import-1" class="level2">
<h2>User Import</h2>
<p><code>/etc/rhn/sw-ldap-user-sync.conf</code></p>
<pre class="yaml"><code>directory:
  user: uid=xyz,dc=example,dc=com
  password: xxx
  url: ldaps://ldap.example.com:636
  group: cn=admin,ou=groups,dc=example,dc=com
  users: ou=people,dc=example,dc=com
spacewalk:
  url: http://localhost/rpc/api
  user: spacewalk
  password: xxx
</code></pre>
<p><code>/usr/bin/sw-ldap-user-sync</code></p>
</section>
</section>
      </div>
    </div>

    <script src="../common/reveal.js/lib/js/head.min.js"></script>
    <script src="../common/reveal.js/js/reveal.js"></script>

    <script>
      // More info https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: false,
        progress: false,
        history: true,
        center: true,

        menu: {
          themes: false,
          transitions: false,
          openButton: false,
          openSlideNumber: true,
          markers: true
        },

        // More info https://github.com/hakimel/reveal.js#dependencies
        dependencies: [
          { src: '../common/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: '../common/reveal.js/plugin/notes/notes.js', async: true },
          { src: '../common/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: '../common/reveal.js-menu/menu.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });
    </script>
  </body>
</html>
