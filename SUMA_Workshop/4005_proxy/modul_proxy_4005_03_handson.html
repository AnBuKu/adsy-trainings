<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>SUSE Manager Proxy</title>

    <link rel="stylesheet" href="../common/reveal.js/css/reveal.css">
    <link rel="stylesheet" href="../common/reveal.js/css/theme/white.css">
    <link rel="stylesheet" href="../common/css/reveal-adsy.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="../common/css/monokai.css">
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
<section id="suse-manager-3-hands-on" class="slide level1">
<h1>SUSE Manager 3 Hands-on</h1>
<figure>
<img src="static/suma.png" />
</figure>
</section>
<section class="slide level1">

<section id="hands-on-proxy-05" class="level2">
<h2>Hands-on :: Proxy 05</h2>
<p>Install the SUMA Proxy and register clients.</p>
</section>
</section>
<section class="slide level1">

<section id="proxy-05---datadisks" class="level2">
<h2>Proxy 05 - Datadisks</h2>
<p>Create the data disk and put a file system on the device:</p>
<pre class="text"><code># pvcreate /dev/vdb

# vgcreate vg_data /dev/vdb

# lvcreate -l100%FREE -n lv_squid_cache vg_data

# mkfs.xfs /dev/mapper/vg_data-lv_squid_cache</code></pre>
</section>
<section id="proxy-05---mount-datadisk" class="level2">
<h2>Proxy 05 - Mount Datadisk</h2>
<p>Add the new devie to the <code>/etc/fstab</code>:</p>
<pre class="text"><code>UUID=2b769250-6dcf-4b5b-b84b-f25df40ca871 /var/cache/squid xfs defaults 0 2</code></pre>
<p>Create the mountpoint and mount the new device:</p>
<pre class="text"><code># mkdir /var/cache/squid

# mount -a</code></pre>
</section>
<section id="proxy-05---activation-key" class="level2">
<h2>Proxy 05 - Activation Key</h2>
<p>Create an activation key for the proxy systems:</p>
<pre class="text"><code># spacecmd activationkey_create
INFO: Connected to https://localhost/rpc/api as admin
Name (blank to autogenerate): ak-sles12sp1-prod-proxy
Description [None]: Activation Key for SUMA Proxies

Base Channels
-------------
archive-20161110-prod-sles12-sp1-pool-x86_64
devl-sles12-sp1-pool-x86_64
prod-sles12-sp1-pool-x86_64
sles12-sp1-pool-x86_64

Base Channel (blank for default): prod-sles12-sp1-pool-x86_64

virtualization_host Entitlement [y/N]: 

Universal Default [y/N]: 
INFO: Created activation key 1-ak-sles12sp1-prod-proxy</code></pre>
</section>
<section id="proxy-05---activation-key-1" class="level2">
<h2>Proxy 05 - Activation Key</h2>
<p>Add the child channels the to proxy activation key:</p>
<pre class="text"><code># spacecmd activationkey_addchildchannels \
           1-ak-sles12sp1-prod-proxy \
           prod-sles12-sp1-updates-x86_64 \
           prod-sle-manager-tools12-pool-x86_64-sp1 \
           prod-sle-manager-tools12-updates-x86_64-sp1 \
           prod-suse-manager-proxy-3.0-pool-x86_64 \
           prod-suse-manager-proxy-3.0-updates-x86_64</code></pre>
</section>
<section id="proxy-05---activation-key-2" class="level2">
<h2>Proxy 05 - Activation Key</h2>
<p>Add the required packages to the acvivation key:</p>
<pre class="text"><code># spacecmd activationkey_addpackages \
           1-ak-sles12sp1-prod-proxy \
           rhncfg-actions \
           osad \
           rhncfg-client \
           rhncfg-management </code></pre>
</section>
<section id="proxy-05---bootstrap-script" class="level2">
<h2>Proxy 05 - Bootstrap Script</h2>
<p>Create a new bootstrap script:</p>
<pre class="text"><code># cd /srv/www/htdocs/pub/bootstrap/
# cp bootstrap{,-proxy}.sh </code></pre>
<p>Modify the bootstrap script:</p>
<pre class="text"><code>[...]
#exit 1

# can be edited, but probably correct (unless created during initial install):
# NOTE: ACTIVATION_KEYS *must* be used to bootstrap a client machine.
ACTIVATION_KEYS=1-ak-sles12sp1-prod-proxy</code></pre>
</section>
<section id="proxy-05---registration" class="level2">
<h2>Proxy 05 - Registration</h2>
<p>Register the proxy system:</p>
<pre class="text"><code># cd /srv/www/htdocs/pub/bootstrap/

# cat bootstrap-proxy.sh | ssh root@proxy&quot;$NR&quot;.net&quot;$NR&quot;.lab /bin/bash</code></pre>
</section>
</section>
<section class="slide level1">

<section id="proxy-05---installation" class="level2">
<h2>Proxy 05 - Installation</h2>
<p>Verify if the proxy pattern is available and install it:</p>
<pre class="text"><code># zypper search -t pattern suma_proxy

# zypper info -t pattern suma_proxy

# zypper install -t pattern suma_proxy</code></pre>
</section>
<section id="proxy-05---configuration" class="level2">
<h2>Proxy 05 - Configuration</h2>
<p>Run <code>configure-proxy.sh</code> to install the required packages:</p>
<pre class="text"><code># configure-proxy.sh</code></pre>
<p>Copy the CA files from the SUMA:</p>
<pre class="text"><code># scp &quot;root@suma&quot;$NR&quot;.net&quot;$NR&quot;.lab:/root/ssl-build/{RHN-ORG-PRIVATE-SSL-KEY,RHN-ORG-TRUSTED-SSL-CERT,rhn-ca-openssl.cnf}&quot; \
/root/ssl-build</code></pre>
<p>Run <code>configure-proxy.sh</code> again:</p>
<pre class="text"><code># configure-proxy.sh</code></pre>
</section>
</section>
<section class="slide level1">

<section id="proxy-05---client-registration-salt" class="level2">
<h2>Proxy 05 - Client Registration Salt</h2>
<p>Add the SUMA tools repository and install the minion package:</p>
<pre class="text"><code># zypper addrepo \
         http://proxy&quot;$NR&quot;.net&quot;$NR&quot;.lab/pub/repositories/sle/12/1/bootstrap/ \
         SUMA3-Tools

# zypper -n install salt-minion</code></pre>
</section>
<section id="proxy-05---client-registration-salt-1" class="level2">
<h2>Proxy 05 - Client Registration Salt</h2>
<p>Configure the minion and do a restart:</p>
<pre class="text"><code># echo &quot;master: proxy&quot;$NR&quot;.net&quot;$NR&quot;.lab&quot; &gt; /etc/salt/minion.d/master.conf

# echo -e &quot;susemanager:\n  activation_key: 1-ak-sles12sp1-devl-salt&quot; &gt; /etc/salt/grains

# systemctl restart salt-minion</code></pre>
</section>
<section id="proxy-05---client-registration-salt-2" class="level2">
<h2>Proxy 05 - Client Registration Salt</h2>
<p>Accept the new minion on the SUMA:</p>
<pre class="text"><code># salt-key -L

# salt-key -A</code></pre>
</section>
<section id="proxy-05---client-registration-rhn" class="level2">
<h2>Proxy 05 - Client Registration RHN</h2>
<p>Create a bootstrap script on the proxy:</p>
<pre class="text"><code># mgr-bootstrap --activation-keys=1-ak-sles12sp1-prod-trad</code></pre>
<p>Register the new client (pull):</p>
<pre class="text"><code># curl http://proxy&quot;$NR&quot;.net&quot;$NR&quot;.lab/pub/bootstrap/bootstrap.sh | bash</code></pre>
</section>
</section>
      </div>
    </div>

    <script src="../common/reveal.js/lib/js/head.min.js"></script>
    <script src="../common/reveal.js/js/reveal.js"></script>

    <script>
      // More info https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: false,
        progress: false,
        history: true,
        center: true,

        menu: {
          themes: false,
          transitions: false,
          openButton: false,
          openSlideNumber: true,
          markers: true
        },

        // More info https://github.com/hakimel/reveal.js#dependencies
        dependencies: [
          { src: '../common/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: '../common/reveal.js/plugin/notes/notes.js', async: true },
          { src: '../common/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: '../common/reveal.js-menu/menu.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });
    </script>
  </body>
</html>
